<?php

/**
 * @file
 * Contains dashpage.module.
 */

use Drupal\Core\Language\LanguageInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\node\Entity\Node;

/**
 * @Implements hook_help().
 */
function dashpage_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the dashpage module.
    case 'help.page.dashpage':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Custom layout page') . '</p>';
      return $output;

    default:
  }
}

/**
 * @Implements hook_page_attachments()
 *
 */
function dashpage_page_attachments(array &$page) {
  // if (!\Drupal::currentUser()->hasPermission('access contextual links')) {
  //   return;
  // }

  $page['#attached']['library'][] = 'dashpage/dashpage-page-style';
  $page['#attached']['library'][] = 'dashpage/dashpage-global-styling';
  $page['#attached']['library'][] = 'dashpage/fontawesome-free';

  return;
}

/**
 * Implements hook_theme().
 */
function dashpage_theme() {
  return [
    'index_carousel_block' => [
      'variables' => [
        'carouselrows' => [],
      ],
      'template' => 'index-carousel-block',
    ],
    'feature_product_block' => [
      'variables' => [
        'details' => [],
        'productlogos' => [],
      ],
      'template' => 'feature-product-block',
    ],
    'feature_first_block' => [
      'variables' => [
        'solutions' => [],
      ],
      'template' => 'feature-first-block',
    ],
    'feature_third_block' => [
      'variables' => [
        'features' => [],
        'news' => [],
      ],
      'template' => 'feature-third-block',
    ],
  ];
}

/**
 * Preprocess for feature_third_block.
 */
function template_preprocess_feature_third_block(array &$variables) {
  $variables['news'] = _get_latest_news();
}

/**
 * Get the last 6 news articles.
 */
function _get_latest_news() {
  $langcode = \Drupal::languageManager()->getCurrentLanguage(LanguageInterface::TYPE_INTERFACE)->getId();
  $language = \Drupal::languageManager()->getLanguage($langcode);

  $query = \Drupal::entityQuery('node')
    ->condition('type', 'article')
    ->condition('status', 1)
    ->condition('field_article_news', NULL, 'IS NOT NULL')
    ->sort('created', 'DESC')
    ->range(0, 6)
    ->accessCheck(TRUE);

  $nids = $query->execute();

  if (empty($nids)) {
    return [];
  }

  // Performance: load in batch.
  $nodes = Node::loadMultiple($nids);

  $articles = [];
  foreach ($nids as $nid) {
    if (empty($nodes[$nid])) {
      continue;
    }

    $node = $nodes[$nid];

    // If translation exists, use it; otherwise fallback to default language.
    if ($node->hasTranslation($langcode)) {
      $node = $node->getTranslation($langcode);
    }

    $articles[] = [
      // label() respects translation
      'title' => $node->label(),

      // toUrl() respects translation + language prefix + alias
      'src' => $node->toUrl('canonical', ['language' => $language])->toString(),
    ];
  }

  return $articles;
}
